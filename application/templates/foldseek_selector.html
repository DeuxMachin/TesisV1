<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visualización de Estructuras Proteicas Alineadas</title>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; background-color: #1c1c1c; color: white; }
        select, button { padding: 8px; margin: 8px 0; width: 100%; }
        .viewer-container { width: 100%; height: 500px; margin-top: 20px; }
        .alert { background-color: #665c00; color: #fff6b0; padding: 15px; margin-top: 20px; }
    </style>
</head>
<body>

    <h1>Visualización de Estructuras Proteicas Alineadas</h1>
    <form method="POST">
        <label for="source">Seleccione el tipo de procesamiento:</label>
        <select id="source" name="source" onchange="this.form.submit()">
            <option value="">-- Seleccione --</option>
            <option value="foldseek" {{ 'selected' if selected_source == 'foldseek' else '' }}>FoldSeek</option>
            <option value="uniprot" {{ 'selected' if selected_source == 'uniprot' else '' }}>UniProt</option>
        </select>

        {% if selected_source %}
            <label for="structure_id">Seleccione una estructura:</label>
            <select id="structure_id" name="structure_id">
                {% if selected_source == 'foldseek' %}
                    {% for s in foldseek_structures %}
                        <option value="{{ s.alignment_detail_id }}" {{ 'selected' if s.alignment_detail_id|string == selected_id }}> 
                            {{ s.database_name }} - {{ s.target }}
                        </option>
                    {% endfor %}
                {% elif selected_source == 'uniprot' %}
                    {% for s in uniprot_structures %}
                        <option value="{{ s.alignment_id }}" {{ 'selected' if s.alignment_id|string == selected_id }}> 
                            {{ s.protein_name }} ({{ s.accession_number }})
                        </option>
                    {% endfor %}
                {% endif %}
            </select>

            <button type="submit">Procesar Estructura</button>
        {% endif %}
    </form>

    <h2>Visualizador de Mutaciones</h2>

    {% if ref_pdb and aligned_pdb %}
        <div id="viewer" class="viewer-container"></div>
        <script>
            const viewer = $3Dmol.createViewer("viewer", { backgroundColor: "white" });
            viewer.addModel(`{{ ref_pdb }}`, "pdb");
            viewer.setStyle({}, { cartoon: { color: 'lightblue' } });
            viewer.addModel(`{{ aligned_pdb }}`, "pdb");
            viewer.setStyle({model: 1}, { cartoon: { color: 'orange' } });
            viewer.zoomTo();
            viewer.render();
        </script>
    {% else %}
        <div class="alert">
            No hay estructura PDB cargada. Por favor, procese primero una estructura.
        </div>
    {% endif %}

</body>
</html>
